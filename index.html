<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Angle Arena ‚Äî Algebra & Angles Game</title>
  <style>
    :root{--bg:#0b1020;--panel:#0f172a;--ink:#e5e7eb;--muted:#9ca3af;--accent:#38bdf8;--good:#10b981;--bad:#f43f5e;--warn:#f59e0b}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,Apple Color Emoji,Segoe UI Emoji;background:radial-gradient(1200px 800px at 50% -100px,#111a33,#0b1020 60%);color:var(--ink);overflow-x:hidden}
    .wrap{max-width:1100px;margin:0 auto;padding:20px;position:relative;z-index:2}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    h1{margin:0;font-size:clamp(20px,3vw,32px)}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    button,select,input{background:var(--panel);color:var(--ink);border:1px solid #1f2937;border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer}
    button:hover{border-color:#334155}
    .grid{display:grid;grid-template-columns:1.15fr .85fr;gap:16px;margin-top:14px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .card{background:rgba(13,24,48,.85);border:1px solid #1e293b;border-radius:18px;padding:16px;box-shadow:0 20px 60px rgba(0,0,0,.35)}
    .hud{display:flex;gap:10px;flex-wrap:wrap;margin:8px 0}
    .badge{background:#0a1328;border:1px solid #1f2b40;border-radius:999px;padding:6px 10px;font-weight:700}
    .accent{color:var(--accent)}
    .good{color:var(--good)}
    .bad{color:var(--bad)}
    .warn{color:var(--warn)}
    .equation{font-size:clamp(18px,2.2vw,26px);font-weight:800;letter-spacing:.3px;margin:0}
    .sub{opacity:.8;font-size:14px;margin-top:6px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:8px 0}
    .row input{width:160px}
    .steps{background:#0a1328;border:1px dashed #22324a;border-radius:12px;padding:10px;margin-top:8px}
    .diagram{background:linear-gradient(180deg,#0e162f,#0a1226);border:1px solid #1e293b;border-radius:14px;height:300px;display:grid;place-items:center}
    .small{font-size:12px;color:var(--muted)}
    .leader{max-height:260px;overflow:auto}
    .leader table{width:100%;border-collapse:collapse}
    .leader th,.leader td{padding:8px;border-bottom:1px solid #22324a;text-align:left}
    .toast{position:fixed;inset:auto 0 20px 0;display:grid;place-items:center;pointer-events:none;z-index:50}
    .toast > div{background:#071026;border:1px solid #1b2a45;padding:10px 14px;border-radius:999px}
    .hidden{display:none}
    .legend{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
    .legend .chip{border:1px solid #22324a;border-radius:999px;padding:4px 8px;background:#0b1329;font-size:12px}
    /* Arena background */
    .arena-bg{position:fixed; inset:0; z-index:0; pointer-events:none;}
    .stands{position:absolute; left:50%; transform:translateX(-50%); width:1400px; height:420px; bottom:-40px;
      background:repeating-linear-gradient(to bottom, rgba(255,255,255,.04), rgba(255,255,255,.04) 8px, transparent 8px, transparent 22px),
        linear-gradient(180deg, #0e1a35 0%, #0a1328 60%, #071021 100%);
      border-top-left-radius:60px; border-top-right-radius:60px; border:1px solid #13223d; box-shadow:0 -30px 120px rgba(0,0,0,.5) inset;}
    .crowd{position:absolute; left:50%; transform:translateX(-50%); width:1300px; bottom:120px; display:flex; flex-wrap:wrap; gap:10px; justify-content:center;}
    .fan{font-weight:900; font-size:18px; opacity:.9; transform-origin:center; animation: bob 2.6s ease-in-out infinite; color:#38bdf8;}
    .fan:nth-child(odd){animation-duration:2.2s;color:#f472b6}
    @keyframes bob{0%,100%{transform:translateY(0) rotate(0)}50%{transform:translateY(-6px) rotate(1deg)}}
    .floor{position:absolute; left:0; right:0; bottom:0; height:160px; background:
      radial-gradient(800px 160px at 50% 0px, rgba(56,189,248,.15), transparent 60%),
      radial-gradient(1200px 200px at 50% 0px, rgba(255,255,255,.08), transparent 70%),
      linear-gradient(180deg,#0a1328,#050a16);
      border-top:1px solid #13223d;}
    .confetti{position:absolute; inset:0; overflow:visible; pointer-events:none; z-index:20}
  </style>
</head>
<body>
  <div class="arena-bg" aria-hidden="true">
    <div class="stands"></div>
    <div class="crowd" id="crowd"></div>
    <div class="floor"></div>
  </div>

  <div class="wrap">
    <header>
      <h1>üéØ Angle Arena <span class="small">‚Äî Solve for <em>x</em> with angle relationships</span></h1>
      <div class="controls">
        <select id="mode">
          <option value="classic" selected>Classic (3 min)</option>
          <option value="endless">Endless</option>
          <option value="practice">Practice (no timer)</option>
        </select>
        <select id="difficulty">
          <option value="easy">Easy</option>
          <option value="normal" selected>Normal</option>
          <option value="hard">Hard</option>
        </select>
        <button id="startBtn">Start</button>
        <button id="hintBtn" disabled>Hint</button>
        <button id="skipBtn" disabled>Skip</button>
      </div>
    </header>

    <div class="hud">
      <div class="badge">‚è±Ô∏è Time: <span id="time">‚Äî</span></div>
      <div class="badge">üèÜ Score: <span id="score">0</span></div>
      <div class="badge">üî• Streak: <span id="streak">0</span>x</div>
      <div class="badge">‚≠ê Best: <span id="best">0</span></div>
      <div class="badge">üë§ Name: <input id="player" placeholder="(optional)"/></div>
    </div>

    <div class="grid">
      <section class="card">
        <p id="prompt" class="equation">Press <span class="accent">Start</span> to begin.</p>
        <p id="subprompt" class="sub"></p>

        <div class="row">
          <label>Answer for <strong>x</strong>:</label>
          <input id="answer" type="text" inputmode="decimal" placeholder="e.g., 12, 12.5, or 25/2" />
          <button id="checkBtn" disabled>Check</button>
          <button id="nextBtn" class="hidden">Next ‚ñ∂</button>
          <span id="feedback" class="small"></span>
        </div>

        <div id="bonusArea" class="row hidden">
          <label id="bonusLabel">Bonus:</label>
          <input id="bonusAns" type="text" inputmode="decimal" placeholder="accepts 12.5 or 25/2" />
          <button id="bonusBtn">Check Bonus</button>
          <span id="bonusFeedback" class="small"></span>
        </div>

        <div class="steps" id="steps" hidden></div>
      </section>

      <aside class="card">
        <div class="diagram">
          <svg id="svg" viewBox="0 0 520 300" width="100%" height="100%" aria-label="Angle diagram with labeled points A, B, C (and D if used)"></svg>
          <svg class="confetti" id="confetti" viewBox="0 0 520 300"></svg>
        </div>
        <div class="row" style="justify-content:space-between; margin-top:10px;">
          <div class="small">Relationships in play: <span id="tags">‚Äî</span></div>
          <button id="revealBtn">Show Work</button>
        </div>
        <div class="legend">
          <div class="chip">Vertex <strong>B</strong> is marked. Angles are labeled like ‚à†ABC.</div>
          <div class="chip">Right angle ‚ñ¢, congruent arcs ‚â°, bisector shows equal arcs.</div>
        </div>
        <details style="margin-top:8px;">
          <summary>How scoring works</summary>
          <ul class="small">
            <li>Base 100 pts for a correct x.</li>
            <li>Time bonus up to +50 (faster = more).</li>
            <li>Streak multiplier: √ó(1 + streak/5).</li>
            <li>Bonus angle value: +25 if asked.</li>
          </ul>
        </details>
        <details style="margin-top:8px;">
          <summary>Content covered</summary>
          <ul class="small">
            <li>Complementary / Supplementary / Straight / Right angles</li>
            <li>Perpendicular (right) / Congruent / Adjacent</li>
            <li>Angle bisectors</li>
            <li>Algebra with linear expressions (solve for x)</li>
          </ul>
        </details>
      </aside>
    </div>

    <section class="card" style="margin-top:16px;">
      <h3 style="margin-top:0;">üèÖ Local Leaderboard</h3>
      <div class="leader" id="leader"></div>
    </section>
  </div>

  <div class="toast" id="toast" aria-live="polite"></div>

  <script>
    const $ = sel => document.querySelector(sel);
    const ui = {
      mode: $('#mode'), diff: $('#difficulty'), start: $('#startBtn'), hint: $('#hintBtn'), skip: $('#skipBtn'),
      time: $('#time'), score: $('#score'), streak: $('#streak'), best: $('#best'), player: $('#player'),
      prompt: $('#prompt'), subprompt: $('#subprompt'), ans: $('#answer'), check: $('#checkBtn'), next: $('#nextBtn'), feedback: $('#feedback'),
      steps: $('#steps'), reveal: $('#revealBtn'), tags: $('#tags'), svg: $('#svg'), confetti: $('#confetti'),
      bonusRow: $('#bonusArea'), bonusLabel: $('#bonusLabel'), bonusAns: $('#bonusAns'), bonusBtn: $('#bonusBtn'), bonusFeedback: $('#bonusFeedback'),
      leader: $('#leader'), toast: $('#toast'), crowd: $('#crowd')
    };

    const store = {
      best: Number(localStorage.getItem('angle_arena_best')||0),
      board: JSON.parse(localStorage.getItem('angle_arena_board')||'[]')
    };
    ui.best.textContent = store.best;

    function toast(msg){ ui.toast.innerHTML = `<div>${msg}</div>`; setTimeout(()=> ui.toast.innerHTML = '', 1400); }
    function rng(seed){ let s = seed >>> 0; return ()=> (s = (s*1664525 + 1013904223) >>> 0) / 2**32; }

    let clock = 0, timer = null, running = false, streak = 0, score = 0, roundStart = 0; let genRand = Math.random; let current = null;

    ui.start.addEventListener('click', startGame);
    ui.check.addEventListener('click', checkAnswer);
    ui.next.addEventListener('click', ()=>{ ui.steps.hidden=true; ui.next.classList.add('hidden'); nextProblem(); });
    ui.ans.addEventListener('keydown', e=>{ if(e.key==='Enter') checkAnswer(); });
    ui.reveal.addEventListener('click', ()=> ui.steps.hidden = !ui.steps.hidden);
    ui.hint.addEventListener('click', giveHint);
    ui.skip.addEventListener('click', nextProblem);
    ui.bonusBtn.addEventListener('click', checkBonus);

    function startGame(){
      const seed = (Date.now() ^ (ui.player.value||'class').split('').reduce((a,c)=>a+c.charCodeAt(0),0)) >>> 0;
      genRand = rng(seed); running = true; score = 0; streak = 0; updateHUD(); enablePlay(true);
      if (ui.mode.value === 'classic') { clock = 180; startTimer(); } else if (ui.mode.value === 'endless') { clock = 0; ui.time.textContent = '‚àû'; } else { clock = 0; ui.time.textContent = '‚Äî'; }
      nextProblem(true); makeCrowd();
    }

    function startTimer(){ clearInterval(timer); ui.time.textContent = fmt(clock); timer = setInterval(()=>{ clock--; ui.time.textContent = fmt(clock); if(clock<=0){ endGame(); } },1000); }

    function endGame(){
      clearInterval(timer); running = false; enablePlay(false);
      if (score > store.best){ store.best = score; localStorage.setItem('angle_arena_best', String(store.best)); }
      const name = (ui.player.value||'Player');
      store.board.push({name, score, when: new Date().toLocaleString()});
      store.board.sort((a,b)=>b.score-a.score); store.board = store.board.slice(0,20);
      localStorage.setItem('angle_arena_board', JSON.stringify(store.board));
      ui.best.textContent = store.best; renderBoard(); toast('üèÅ Time! Great run.');
    }

    function enablePlay(on){ ui.hint.disabled = !on; ui.skip.disabled = !on; ui.check.disabled = !on; ui.ans.disabled = !on; ui.bonusBtn.disabled = !on; if(on){ ui.ans.focus(); } }
    function updateHUD(){ ui.score.textContent = score; ui.streak.textContent = streak; }
    function fmt(s){ const m = Math.floor(s/60), r = s%60; return `${m}:${String(r).padStart(2,'0')}`; }

    function parseNumber(s){
      if(/^[-+]?\d+(?:\.\d+)?$/.test(s)) return Number(s);
      const m = s.match(/^\s*([-+]?\d+(?:\.\d+)?)\s*\/\s*([-+]?\d+(?:\.\d+)?)\s*$/);
      if(m){ const num = Number(m[1]); const den = Number(m[2]); if(den===0) return null; return num/den; }
      return null;
    }

    // ====== Problem generation stays same (omitted here for brevity) ======
    // [KEEP your existing generators like genComplementary, genSupplementary, etc.]

    function checkAnswer(){
      if(!running) return; const raw = ui.ans.value.trim(); if(!raw) return; const val = parseNumber(raw); if(val==null){ ui.feedback.textContent='Enter a number (12, 12.5, or 25/2).'; return; }
      const correct = Math.abs(val - current.x) < 1e-9;
      if(correct){
        const elapsed=(Date.now()-roundStart)/1000; const

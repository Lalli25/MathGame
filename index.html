<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Angle Ball ‚öæ ‚Äî Geometry at the Ballpark</title>
  <style>
    :root{
      --ink:#f8fafc; --muted:#a3b1c6; --accent:#22d3ee; --grass:#0f8a2c; --chalk:#e2e8f0;
      --panel:#0b1324; --line:#e5e7eb; --sky1:#0ea5e9; --sky2:#0f172a; --warn:#f97316;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      color:var(--ink);
      background:
        radial-gradient(1200px 600px at 50% -250px, var(--sky1), transparent 65%),
        linear-gradient(180deg, var(--sky2) 0%, #0b1224 55%, #08111e 100%);
      overflow-x:hidden;
    }

    /* Stadium backdrop */
    .stadium{position:fixed; inset:0; z-index:-1; pointer-events:none}
    .outfield{position:absolute; left:50%; transform:translateX(-50%); bottom:-120px; width:1600px; height:700px;
      background:
       radial-gradient(closest-side at 50% 88%, #0c6f25 0%, #0f8a2c 60%, #0a6a22 100%),
       repeating-conic-gradient(from 0deg, rgba(255,255,255,.04) 0deg 10deg, rgba(255,255,255,0) 10deg 20deg);
      border-top-left-radius:70px; border-top-right-radius:70px; filter:drop-shadow(0 -30px 120px rgba(0,0,0,.5));
    }
    .bleachers{position:absolute; left:50%; transform:translateX(-50%); bottom:360px; width:1400px; height:180px;
      background:linear-gradient(180deg,#0c1a35,#08122a); border:1px solid #142a55; border-top-left-radius:50px; border-top-right-radius:50px;
      box-shadow:0 -20px 80px rgba(0,0,0,.55) inset, 0 20px 80px rgba(0,0,0,.35);
    }
    .lights{position:absolute; left:50%; transform:translateX(-50%); bottom:560px; display:flex; gap:420px}
    .tower{width:120px; height:18px; background:linear-gradient(180deg,#e2e8f0,#94a3b8); border-radius:10px; box-shadow:0 0 40px #e2e8f0}

    /* Layout */
    .wrap{max-width:1100px; margin:0 auto; padding:20px}
    header{display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap}
    h1{margin:0; font-size:clamp(22px,3.2vw,34px); color:#e2f3ff; text-shadow:0 2px 0 #06223f}
    .sub{opacity:.85; font-size:14px}

    .board{display:grid; grid-template-columns:1.2fr .8fr; gap:16px; margin-top:14px}
    @media (max-width:960px){ .board{grid-template-columns:1fr} }

    .card{background:rgba(10,20,40,.75); border:1px solid #183154; border-radius:18px; padding:14px; box-shadow:0 20px 60px rgba(0,0,0,.35)}

    /* HUD */
    .hud{display:flex; flex-wrap:wrap; gap:10px}
    .badge{background:#07142b; border:1px solid #1b335a; border-radius:12px; padding:8px 12px; font-weight:800; letter-spacing:.2px}
    .led{font-feature-settings:'tnum' 1; font-variant-numeric:tabular-nums}
    .outs{display:inline-flex; gap:6px; align-items:center}
    .dot{width:10px; height:10px; border-radius:999px; background:#334155; display:inline-block}
    .dot.on{background:#ef4444; box-shadow:0 0 8px #ef4444}

    /* Question panel */
    .equation{font-size:clamp(18px,2.3vw,26px); font-weight:900; color:#facc15; margin:6px 0}
    .diagram{background:linear-gradient(180deg,#0d1a36,#0a1429); border:1px solid #1b2f51; border-radius:14px; height:300px; display:grid; place-items:center}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:8px}
    input,button,select{background:#0c1b36; color:var(--ink); border:1px solid #223a66; border-radius:12px; padding:9px 12px; font-weight:700}
    button{cursor:pointer}
    button:hover{border-color:#2c4e86}
    .feedback{min-height:20px; font-weight:800}
    .steps{background:#0c1b36; border:1px dashed #27446f; border-radius:10px; padding:10px; margin-top:8px}
    .labels{margin-top:6px; text-align:center; font-weight:800; color:#93c5fd; letter-spacing:.2px}

    /* Field panel */
    .field{position:relative; height:300px; border-radius:14px; background:conic-gradient(from 180deg at 50% 100%, #0b7426, #0c7f28 25%, #0a6c23 25%, #0a6c23 50%, #0b7426 50%, #0b7426 75%, #0a6c23 75%, #0a6c23 100%);
      border:1px solid #174d2c; box-shadow:inset 0 0 0 2px rgba(255,255,255,.05)}
    .diamond{position:absolute; inset:18px;}
    canvas#atbat{position:absolute; inset:0; pointer-events:auto}
    .toast{position:absolute; left:50%; bottom:12px; transform:translateX(-50%); background:#07142b; border:1px solid #1b335a; padding:8px 12px; border-radius:999px; font-weight:800; opacity:0; transition:opacity .25s}

    .legend{display:flex; gap:8px; flex-wrap:wrap; margin-top:6px}
    .chip{background:#0c1b36; border:1px solid #223a66; border-radius:999px; padding:4px 8px; font-size:12px}

    .end{display:none; text-align:center}
    .end.show{display:block}
  </style>
</head>
<body>
  <div class="stadium" aria-hidden="true">
    <div class="lights"><div class="tower"></div><div class="tower"></div><div class="tower"></div></div>
    <div class="bleachers"></div>
    <div class="outfield"></div>
  </div>

  <div class="wrap">
    <header>
      <div>
        <h1>Angle Ball ‚öæ</h1>
        <div class="sub">Answer geometry questions to earn your at‚Äëbat. Hits score points. 3 outs or 5:00 ends the game.</div>
      </div>
      <div class="hud">
        <div class="badge">‚è± Time: <span id="time" class="led">5:00</span></div>
        <div class="badge">üèÜ Points: <span id="points" class="led">0</span></div>
        <div class="badge">üèÅ Runs: <span id="runs" class="led">0</span></div>
        <div class="badge">‚öæ Hits: <span id="hits" class="led">0</span></div>
        <div class="badge outs">üß¢ Outs: <span class="dot" id="o1"></span><span class="dot" id="o2"></span><span class="dot" id="o3"></span></div>
        <button id="start">Start Game</button>
      </div>
    </header>

    <div class="board">
      <!-- Question side -->
      <section class="card">
        <div id="prompt" class="equation">Press <span style="color:var(--accent)">Start Game</span> to get your first pitch (question).</div>
        <div class="diagram">
          <svg id="svg" viewBox="0 0 520 300" width="100%" height="100%" aria-label="Angle diagram with labeled points"></svg>
        </div>
        <div id="angleLabels" class="labels"></div>
        <div class="row">
          <label for="answer">Answer for <b>x</b>:</label>
          <input id="answer" type="text" inputmode="numeric" placeholder="Enter a whole number (e.g., 12)" />
          <button id="check" disabled>Check</button>
          <button id="skip">Skip (Out)</button>
        </div>
        <div id="feedback" class="feedback"></div>
        <div id="steps" class="steps" hidden></div>
        <div class="legend">
          <div class="chip">No arcs/ticks: clean rays + labels only</div>
          <div class="chip">Relationships: right, complementary, supplementary, bisector, perpendicular, vertical</div>
        </div>
      </section>

      <!-- Field side -->
      <aside class="card">
        <div class="field" id="field">
          <!-- Diamond (SVG) -->
          <svg class="diamond" id="diamond" viewBox="0 0 520 300">
            <path d="M260 220 L320 160 L260 100 L200 160 Z" fill="none" stroke="var(--chalk)" stroke-width="3" />
            <rect id="base1" x="312" y="152" width="16" height="16" fill="#fff" transform="rotate(45 320 160)"/>
            <rect id="base2" x="252" y="92" width="16" height="16" fill="#fff" transform="rotate(45 260 100)"/>
            <rect id="base3" x="192" y="152" width="16" height="16" fill="#fff" transform="rotate(45 200 160)"/>
            <rect id="home"  x="252" y="212" width="16" height="16" fill="#fff" transform="rotate(45 260 220)"/>
            <circle id="r1" cx="320" cy="160" r="6" fill="#e11d48" opacity="0" />
            <circle id="r2" cx="260" cy="100" r="6" fill="#e11d48" opacity="0" />
            <circle id="r3" cx="200" cy="160" r="6" fill="#e11d48" opacity="0" />
          </svg>
          <canvas id="atbat" width="520" height="300" aria-label="At-bat mini-game canvas"></canvas>
          <div class="toast" id="toast" aria-live="polite"></div>
        </div>
        <div class="legend" style="margin-top:8px">
          <div class="chip">Correct answer ‚Üí 3-sec countdown ‚Üí at-bat mini game</div>
          <div class="chip">Whiff or wrong answer ‚Üí out</div>
          <div class="chip">Single/Double/Triple/HR advance runners</div>
        </div>
        <div class="end" id="end">
          <h3>Game Over!</h3>
          <p>Runs: <b id="endRuns">0</b> ¬∑ Hits: <b id="endHits">0</b> ¬∑ Points: <b id="endPoints">0</b></p>
          <button id="restart">Play Again</button>
        </div>
      </aside>
    </div>
  </div>

  <script>
    // ========= Elements =========
    const $ = s => document.querySelector(s);
    const ui = {
      start: $('#start'), restart: $('#restart'),
      time: $('#time'), points: $('#points'), runs: $('#runs'), hits: $('#hits'),
      o1: $('#o1'), o2: $('#o2'), o3: $('#o3'),
      prompt: $('#prompt'), ans: $('#answer'), check: $('#check'), skip: $('#skip'),
      feedback: $('#feedback'), steps: $('#steps'),
      svg: $('#svg'), labels: $('#angleLabels'), toast: $('#toast'),
      r1: $('#r1'), r2: $('#r2'), r3: $('#r3'),
      end: $('#end'), endRuns: $('#endRuns'), endHits: $('#endHits'), endPoints: $('#endPoints'),
      atbat: $('#atbat')
    };

    // ========= State =========
    let running=false, timer=null, timeLeft=300; // 5 minutes
    let outs=0, points=0, runs=0, hits=0;
    let bases = { first:false, second:false, third:false };
    let current=null; // current problem

    // At-bat
    let batting=false, swing=false, ballX=40, ballY=220, ballV=7.2, plateX=260; // harder
    let countdownTimer=null, countingDown=false;

    // ========= Utils =========
    function fmtTime(s){ const m=Math.floor(s/60), r=s%60; return `${m}:${String(r).padStart(2,'0')}` }
    function setOuts(n){ outs=n; [ui.o1,ui.o2,ui.o3].forEach((d,i)=> d.classList.toggle('on', i < outs)); }
    function showToast(t){ ui.toast.textContent=t; ui.toast.style.opacity='1'; setTimeout(()=> ui.toast.style.opacity='0', 1100); }

    // ========= Diagram helpers (no arcs/ticks) =========
    const BX=260, BY=210, RAD=120; // fit within frame
    function NS(tag){ return document.createElementNS('http://www.w3.org/2000/svg', tag); }
    function drawBase(){ ui.svg.innerHTML=''; const bg=NS('rect'); bg.setAttribute('x',0); bg.setAttribute('y',0); bg.setAttribute('width',520); bg.setAttribute('height',300); bg.setAttribute('fill','#0b142a'); ui.svg.appendChild(bg); }
    function line(x1,y1,x2,y2){ const el=NS('line'); el.setAttribute('x1',x1); el.setAttribute('y1',y1); el.setAttribute('x2',x2); el.setAttribute('y2',y2); el.setAttribute('stroke','#ffffff'); el.setAttribute('stroke-width','4'); el.setAttribute('stroke-linecap','round'); return el; }
    function dot(x,y){ const c=NS('circle'); c.setAttribute('cx',x); c.setAttribute('cy',y); c.setAttribute('r',4); c.setAttribute('fill','#22d3ee'); return c; }
    function textEl(x,y,t,fill='#facc15'){ const el=NS('text'); el.setAttribute('x',x); el.setAttribute('y',y); el.setAttribute('fill',fill); el.setAttribute('font-weight','800'); el.setAttribute('font-size','15'); el.textContent=t; return el; }
    function polar(cx,cy,r,a){ const R=a*Math.PI/180; return {x: cx + r*Math.cos(R), y: cy - r*Math.sin(R)} }
    function labelABC(A,C){ ui.svg.appendChild(textEl(A.x+6,A.y+18,'A','#c7d2fe')); ui.svg.appendChild(textEl(BX-16,BY+18,'B','#c7d2fe')); ui.svg.appendChild(textEl(C.x-14,C.y-8,'C','#c7d2fe')); }
    function labelABCD(A,C,D){ labelABC(A,C); ui.svg.appendChild(textEl(D.x-10,D.y-8,'D','#c7d2fe')); }
    function labelABCDE(A,C,D,E){ labelABCD(A,C,D); ui.svg.appendChild(textEl(E.x-10,E.y-8,'E','#c7d2fe')); }
    function drawRayTo(cx,cy,pt){ ui.svg.appendChild(line(cx,cy,pt.x,pt.y)); }

    // ========= Problem Generators (integer x only) =========
    function ri(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }

    function genRight(){
      const a=ri(1,4), x=ri(5,60), b=90 - a*x;
      const prompt=`m‚à†ABC = ${a}x ${b>=0?'+':''}${b}¬∞. ‚à†ABC is a right angle. Solve for x.`;
      const steps=`Right angle is 90¬∞ ‚áí ${a}x ${b>=0?'+':''}${b} = 90 ‚áí x = ${x}`;
      const labels=`m‚à†ABC = <b>${a}x ${b>=0?'+':''}${b}¬∞</b>`;
      function draw(){ drawBase(); const A=polar(BX,BY,RAD,0), C=polar(BX,BY,RAD,90);
        drawRayTo(BX,BY,A); drawRayTo(BX,BY,C);
        // small right-corner square
        const r=14; const p1=polar(BX,BY,r,0), p2=polar(BX,BY,r,90), p3={x:p1.x+p2.x-BX,y:p1.y+p2.y-BY};
        const sq=NS('path'); sq.setAttribute('d',`M ${BX} ${BY} L ${p1.x} ${p1.y} L ${p3.x} ${p3.y} L ${p2.x} ${p2.y} Z`); sq.setAttribute('fill','#22d3ee'); sq.setAttribute('opacity','0.35'); sq.setAttribute('stroke','#38bdf8'); sq.setAttribute('stroke-width','2'); ui.svg.appendChild(sq);
        ui.svg.appendChild(dot(BX,BY)); labelABC(A,C); }
      return {prompt, steps, x, draw, labels}; }

    function genSupp(){
      const a=ri(1,3), c=ri(1,3), x=ri(4,50); const b=ri(-10,40), d=180-(a+c)*x - b;
      const prompt=`Ray BD splits ‚à†ABC. m‚à†ABD = ${a}x ${b>=0?'+':''}${b}¬∞, m‚à†DBC = ${c}x ${d>=0?'+':''}${d}¬∞. They are supplementary. Solve for x.`;
      const steps=`Supplementary ‚áí sum 180¬∞. (${a}x ${b>=0?'+':''}${b}) + (${c}x ${d>=0?'+':''}${d}) = 180 ‚áí ${(a+c)}x ${b+d>=0?'+':''}${b+d} = 180 ‚áí x = ${x}`;
      const labels=`m‚à†ABD = <b>${a}x ${b>=0?'+':''}${b}¬∞</b> ‚Ä¢ m‚à†DBC = <b>${c}x ${d>=0?'+':''}${d}¬∞</b>`;
      function draw(){ drawBase(); const A=polar(BX,BY,RAD,0), C=polar(BX,BY,RAD,180), D=polar(BX,BY,RAD,ri(40,140)); drawRayTo(BX,BY,A); drawRayTo(BX,BY,C); drawRayTo(BX,BY,D); ui.svg.appendChild(dot(BX,BY)); labelABCD(A,C,D); }
      return {prompt, steps, x, draw, labels}; }

    function genComp(){
      const a=ri(1,3), c=ri(1,3), x=ri(4,50); const b=ri(-10,30), d=90-(a+c)*x - b;
      const prompt=`Ray BD splits ‚à†ABC. m‚à†ABD = ${a}x ${b>=0?'+':''}${b}¬∞, m‚à†DBC = ${c}x ${d>=0?'+':''}${d}¬∞. They are complementary. Solve for x.`;
      const steps=`Complementary ‚áí sum 90¬∞. (${a}x ${b>=0?'+':''}${b}) + (${c}x ${d>=0?'+':''}${d}) = 90 ‚áí ${(a+c)}x ${b+d>=0?'+':''}${b+d} = 90 ‚áí x = ${x}`;
      const labels=`m‚à†ABD = <b>${a}x ${b>=0?'+':''}${b}¬∞</b> ‚Ä¢ m‚à†DBC = <b>${c}x ${d>=0?'+':''}${d}¬∞</b>`;
      function draw(){ drawBase(); const A=polar(BX,BY,RAD,0), C=polar(BX,BY,RAD,90), D=polar(BX,BY,RAD,ri(25,65)); drawRayTo(BX,BY,A); drawRayTo(BX,BY,C); drawRayTo(BX,BY,D); ui.svg.appendChild(dot(BX,BY)); labelABCD(A,C,D); }
      return {prompt, steps, x, draw, labels}; }

    function genBis(){
      const totals=[80,100,120,140];
      const total=totals[ri(0,totals.length-1)], half=total/2;
      const a=ri(1,4), c=ri(1,4);
      const x=ri(4,60);
      const b = half - a*x; const d = half - c*x;
      const prompt=`BD bisects ‚à†ABC (m‚à†ABC=${total}¬∞). m‚à†ABD = ${a}x ${b>=0?'+':''}${b}¬∞, m‚à†DBC = ${c}x ${d>=0?'+':''}${d}¬∞. Solve for x.`;
      const steps=`Bisector ‚áí each part is ${half}¬∞. So ${a}x ${b>=0?'+':''}${b} = ${half} and ${c}x ${d>=0?'+':''}${d} = ${half} ‚áí x = ${x}.`;
      const labels=`m‚à†ABD = <b>${a}x ${b>=0?'+':''}${b}¬∞</b> ‚Ä¢ m‚à†DBC = <b>${c}x ${d>=0?'+':''}${d}¬∞</b> ‚Ä¢ m‚à†ABC = <b>${total}¬∞</b>`;
      function draw(){ drawBase(); const A=polar(BX,BY,RAD,20), C=polar(BX,BY,RAD,20+total), D=polar(BX,BY,RAD,20+half); drawRayTo(BX,BY,A); drawRayTo(BX,BY,C); drawRayTo(BX,BY,D); ui.svg.appendChild(dot(BX,BY)); labelABCD(A,C,D); }
      return {prompt, steps, x, draw, labels}; }

      function genPerp(){
        const a=ri(1,4), x=ri(5,60), b=90 - a*x;
        const prompt=`BA ‚üÇ BC at B. If m‚à†ABC = ${a}x ${b>=0?'+':''}${b}¬∞, solve for x.`;
        const steps=`Perpendicular ‚áí 90¬∞: ${a}x ${b>=0?'+':''}${b} = 90 ‚áí x = ${x}`;
        const labels=`m‚à†ABC = <b>${a}x ${b>=0?'+':''}${b}¬∞</b>`;
        function draw(){ drawBase(); const A=polar(BX,BY,RAD,0), C=polar(BX,BY,RAD,90); drawRayTo(BX,BY,A); drawRayTo(BX,BY,C);
          const r=14; const p1=polar(BX,BY,r,0), p2=polar(BX,BY,r,90), p3={x:p1.x+p2.x-BX,y:p1.y+p2.y-BY}; const sq=NS('path');
          sq.setAttribute('d',`M ${BX} ${BY} L ${p1.x} ${p1.y} L ${p3.x} ${p3.y} L ${p2.x} ${p2.y} Z`); sq.setAttribute('fill','#22d3ee'); sq.setAttribute('opacity','0.35'); sq.setAttribute('stroke','#38bdf8'); sq.setAttribute('stroke-width','2'); ui.svg.appendChild(sq);
          ui.svg.appendChild(dot(BX,BY)); labelABC(A,C); }
        return {prompt, steps, x, draw, labels}; }

    function genVertical(){
      const base=ri(10,40); const sep=ri(40,80);
      const t1=base, t1opp=(t1+180)%360;
      const t2=(base+sep)%360, t2opp=(t2+180)%360;
      const A=polar(BX,BY,RAD,t1), D=polar(BX,BY,RAD,t1opp), C=polar(BX,BY,RAD,t2), E=polar(BX,BY,RAD,t2opp);
      let a=ri(1,4), c=ri(1,4); while(a===c) c=ri(1,4);
      const x=ri(5,70); const b=ri(-10,25); const d=a*x + b - c*x; // equality at integer x
      const prompt=`Two lines intersect at B. ‚à†ABE and ‚à†CBD are vertical angles. m‚à†ABE = ${a}x ${b>=0?'+':''}${b}¬∞, m‚à†CBD = ${c}x ${d>=0?'+':''}${d}¬∞. Solve for x.`;
      const steps=`Vertical angles are congruent ‚áí ${a}x ${b>=0?'+':''}${b} = ${c}x ${d>=0?'+':''}${d} ‚áí x = ${x}.`;
      const labels=`m‚à†ABE = <b>${a}x ${b>=0?'+':''}${b}¬∞</b> ‚Ä¢ m‚à†CBD = <b>${c}x ${d>=0?'+':''}${d}¬∞</b>`;
      function draw(){ drawBase(); drawRayTo(BX,BY,A); drawRayTo(BX,BY,D); drawRayTo(BX,BY,C); drawRayTo(BX,BY,E); ui.svg.appendChild(dot(BX,BY)); labelABCDE(A,C,D,E); }
      return {prompt, steps, x, draw, labels}; }

    const GENS=[genRight, genSupp, genComp, genBis, genPerp, genVertical, genVertical];

    // ========= At-bat mini-game =========
    const ctx = ui.atbat.getContext('2d');
    function drawAtBatBG(){ ctx.clearRect(0,0,520,300); ctx.fillStyle='rgba(0,0,0,0)'; ctx.fillRect(0,0,520,300); ctx.fillStyle='#e2e8f0'; ctx.save(); ctx.translate(plateX, 240); ctx.rotate(Math.PI/4); ctx.fillRect(-10,-10,20,20); ctx.restore(); ctx.strokeStyle='#e2e8f0'; ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(plateX, 240); ctx.lineTo(plateX, 280); ctx.stroke(); }

    function prepAtBatCountdown(){ if(countingDown) return; countingDown=true; let c=3; ui.toast.style.opacity='1'; ui.toast.textContent = `Pitch in ${c}‚Ä¶`; ui.check.disabled=true; ui.ans.disabled=true; countdownTimer=setInterval(()=>{ c--; if(c>0){ ui.toast.textContent = `Pitch in ${c}‚Ä¶`; } else { clearInterval(countdownTimer); countingDown=false; ui.toast.textContent='Swing!'; ui.steps.hidden=true; ui.feedback.textContent=''; ui.atbat.style.pointerEvents='auto'; startAtBat(); } },1000); }

    function startAtBat(){ batting=true; swing=false; ballX=40; ballY=220; drawAtBatBG(); requestAnimationFrame(stepAtBat); }
    function stepAtBat(){ if(!batting) return; drawAtBatBG(); ctx.beginPath(); ctx.fillStyle='#f59e0b'; ctx.arc(ballX, ballY, 7, 0, Math.PI*2); ctx.fill(); if(swing){ ctx.strokeStyle='#22d3ee'; ctx.lineWidth=6; ctx.beginPath(); ctx.arc(plateX, 220, 22, -Math.PI/3, Math.PI/3); ctx.stroke(); } ballX += ballV; if(ballX > plateX+40){ resolveSwing('out'); } else if (batting) { requestAnimationFrame(stepAtBat); } }

    function onSwing(){ if(!batting) return; swing=true; const dist=Math.abs(ballX - plateX); let outcome='out'; if(dist <= 5) outcome='homer'; else if(dist <= 14) outcome='triple'; else if(dist <= 24) outcome='double'; else if(dist <= 40) outcome='single'; resolveSwing(outcome); }

    function resolveSwing(result){ batting=false; swing=false; ui.atbat.style.pointerEvents='none'; ui.check.disabled=false; ui.ans.disabled=false; if(result==='out'){ setOuts(outs+1); showToast('Whiff ‚Äî OUT'); checkEnd(); if(running) newProblem(); return; } hits++; points += 100; ui.hits.textContent=hits; ui.points.textContent=points; const { bases: nb, runs: r } = advanceRunners(bases, result); bases = nb; runs += r; ui.runs.textContent=runs; drawRunners(); showToast(result.toUpperCase()+ (r?` (+${r} run${r>1?'s':''})`:'') ); if(running) setTimeout(newProblem, 600); }

    function drawRunners(){ ui.r1.style.opacity = bases.first? 1:0; ui.r2.style.opacity = bases.second?1:0; ui.r3.style.opacity = bases.third? 1:0; }
    function advanceRunners(bases, result){ let runs=0; const b={...bases}; const scoreIf=pos=>{ if(b[pos]){ runs++; b[pos]=false; } }; if(result==='single'){ scoreIf('third'); const third=b.second; const second=b.first; b.third=!!third; b.second=!!second; b.first=true; } else if(result==='double'){ scoreIf('third'); scoreIf('second'); const third=b.first; b.third=!!third; b.second=true; b.first=false; } else if(result==='triple'){ scoreIf('third'); scoreIf('second'); scoreIf('first'); b.third=true; b.second=false; b.first=false; } else if(result==='homer'){ scoreIf('third'); scoreIf('second'); scoreIf('first'); runs++; b.first=b.second=b.third=false; } return { bases:b, runs }; }

    // ========= Game flow =========
    function newProblem(){ try{ if(!GENS || !GENS.length) throw new Error('No problem generators'); current = GENS[ri(0,GENS.length-1)](); if(!current || !current.draw) throw new Error('Generator failed'); ui.prompt.innerHTML = current.prompt; current.draw(); ui.labels.innerHTML = current.labels || ''; ui.steps.hidden=true; ui.feedback.textContent=''; ui.ans.value=''; ui.check.disabled=false; } catch(err){ ui.prompt.textContent = 'Fallback: ‚à†ABC is right. m‚à†ABC = 2x + 10. Solve for x.'; ui.svg.innerHTML=''; const A=polar(BX,BY,RAD,0), C=polar(BX,BY,RAD,90); ui.svg.appendChild(line(BX,BY,A.x,A.y)); ui.svg.appendChild(line(BX,BY,C.x,C.y)); ui.svg.appendChild(dot(BX,BY)); labelABC(A,C); current = { x:(90-10)/2, steps:'2x+10=90 ‚áí x=40' }; if(ui.labels) ui.labels.innerHTML = 'm‚à†ABC = <b>2x + 10¬∞</b>'; showToast('‚ö†Ô∏è '+(err.message||err)); } }

    function startGame(){ points=0; runs=0; hits=0; outs=0; bases={first:false,second:false,third:false}; running=true; timeLeft=300; ui.points.textContent='0'; ui.hits.textContent='0'; ui.runs.textContent='0'; drawRunners(); setOuts(0); ui.end.classList.remove('show'); ui.check.disabled=false; ui.ans.disabled=false; newProblem(); clearInterval(timer); ui.time.textContent = fmtTime(timeLeft); timer=setInterval(()=>{ timeLeft--; ui.time.textContent = fmtTime(timeLeft); if(timeLeft<=0){ endGame(); } },1000); showToast('Starting‚Ä¶'); }

    function endGame(){ running=false; clearInterval(timer); ui.check.disabled=true; ui.ans.disabled=true; ui.steps.hidden=false; ui.steps.innerHTML='<b>Game Over.</b> Thanks for playing!'; ui.end.classList.add('show'); ui.endRuns.textContent=runs; ui.endHits.textContent=hits; ui.endPoints.textContent=points; }
    function checkEnd(){ if(outs>=3){ endGame(); } }

    function parseIntOnly(s){ if(/^[-+]?\d+$/.test(s)) return Number(s); return null; }
    function submitAnswer(){ if(!running||batting||countingDown) return; const v=parseIntOnly(ui.ans.value.trim()); if(v===null){ ui.feedback.textContent='Enter a whole number (no decimals).'; return; } if(Math.abs(v - current.x) < 1e-9){ ui.feedback.textContent='‚úÖ Correct! Get ready to swing‚Ä¶'; ui.steps.hidden=false; ui.steps.innerHTML=current.steps; prepAtBatCountdown(); } else { ui.feedback.textContent='‚ùå Strike ‚Äî that\'s an out.'; setOuts(outs+1); checkEnd(); if(running) newProblem(); } }

    // ========= Controls =========
    function wireControls(){ try{ ui.check?.addEventListener('click', submitAnswer); ui.skip?.addEventListener('click', ()=>{ if(!running||batting||countingDown) return; setOuts(outs+1); showToast('Skip = Out'); checkEnd(); if(running) newProblem(); }); ui.start?.addEventListener('click', startGame); ui.restart?.addEventListener('click', startGame); ui.ans?.addEventListener('keydown', e=>{ if(e.key==='Enter') submitAnswer(); }); window.addEventListener('keydown', e=>{ if(e.code==='Space'){ e.preventDefault(); onSwing(); } }); ui.atbat?.addEventListener('click', onSwing); } catch(err){ showToast('‚ö†Ô∏è Controls failed'); console.error(err); } }
    if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', wireControls); } else { wireControls(); }

    // initial background draw
    drawBase();
  </script>
</body>
</html>
